<!DOCTYPE html>
<html>
  <head>
    <title>Orchestrate Java Client</title>
    <meta charset='utf-8'>
    <meta content='A high performance, asynchronous Java client to query the Orchestrate.io service.' name='description'>
    <meta content='on' http-equiv='cleartype'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script>
      window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
      window.analytics.load("nkkww5j074");
      window.analytics.page('Docs', 'Java Client');
    </script>
  </head>
  <body>
    <nav>
      <h1>
        <a href="/">orchestrate.io</a>
      </h1>
      <h2>
        <a href="/">Introduction</a>
      </h2>
      <ul>
        <li>
          <a href="/#about">About Orchestrate</a>
        </li>
        <li>
          <a href="/#getting-started">Getting Started</a>
        </li>
        <li>
          <a href="/#managed-dependency">Managed Dependency</a>
        </li>
        <li>
          <a href="/#download">Download</a>
          <a href='https://github.com/orchestrate-io/orchestrate-java-client'>(GitHub)</a>
        </li>
        <li>
          <a href="/#javadoc">Javadoc</a>
          <a href='/javadoc/latest/'>(latest)</a>
        </li>
      </ul>
      <h2>
        <a href="/querying/">Querying</a>
      </h2>
      <ul>
        <li>
          <a href="/querying/#key-value">Key-Value</a>
        </li>
        <li>
          <a href="/querying/#search">Search</a>
        </li>
        <li>
          <a href="/querying/#events">Events</a>
        </li>
        <li>
          <a href="/querying/#graph">Graph</a>
        </li>
        <li>
          <a href="/querying/#async-api">Async API</a>
        </li>
      </ul>
      <h2>
        <a href="/examples/">Examples</a>
      </h2>
      <ul>
        <li>
          <a href="/examples/#listenable-future">Listenable Future</a>
        </li>
        <li>
          <a href="/examples/#data-access-object">DAO Pattern</a>
        </li>
        <li>
          <a href="/examples/#dropwizard">Dropwizard (Managed)</a>
        </li>
        <li>
          <a href="/examples/#error-handling">Error Handling</a>
        </li>
      </ul>
      <h2>
        <a href="/advanced-options/">Advanced Options</a>
      </h2>
      <ul>
        <li>
          <a href="/advanced-options/#tuning">Tuning the Client</a>
        </li>
        <li>
          <a href="/advanced-options/#json-mapping">Custom JSON Mapping</a>
        </li>
      </ul>
      <h2>
        <a href="/feedback/">Feedback</a>
      </h2>
      <ul>
        <li>
          <a href="/feedback/#feature-proposals">Feature Proposals</a>
        </li>
        <li>
          <a href="/feedback/#debugging-requests">Debugging Requests</a>
        </li>
        <li>
          <a href="/feedback/#issues">Issues</a>
        </li>
      </ul>
    </nav>
    <div class='content'>
      <h1>Orchestrate Java Client</h1>
      <p>The client API is designed around the concept of operations you can execute on
       the Orchestrate.io service. The client library is entirely <em>asynchronous</em>. 
       However, most examples here show the blocking variation, because it makes the
       examples easier to understand. Please see the <a href="#async-api">Async API</a> section 
       for more details about how the Blocking vs Non-Blocking approaches work.</p>
      
      <p>Under the hood the client makes <code>HTTP</code> requests to the <a href="http://docs.orchestrate.io/">REST API</a>.
       All data is written to the platform as <a href="http://json.org/"><code>JSON</code></a> and the client
       will handle marshalling and unmarshalling the data into Java objects.</p>
      
      <p>Every Key/Value object has metadata associated with it. This is the &ldquo;path&rdquo; metadata that 
       Orchestrate associates with the data, and includes in operation responses. The client 
       will parse this metadata and make it available either in KvMetadata objects (for most 
       create, update, and delete operations), or in the KvObject (for query operations). For 
       query operations, the Item&rsquo;s value is also provided as the &lsquo;value&rsquo; property of the KvObject.
       Therefore, most of the responses and response handlers in the client either provide 
       KvMetadata objects or KvObjects.</p>
      
      <h3><a name="constructing-a-client"></a> <a href="#constructing-a-client">Constructing a Client</a></h3>
      
      <p>A <code>Client</code> object is the starting point for making requests to the
       Orchestrate.io service, it manages the connection pool and makes <code>HTTP</code>
       requests to the <a href="http://docs.orchestrate.io/">REST API</a>.</p>
      
      <p>You construct a client using the <code>API key</code> for your <code>Application</code> which can be
       found in the <a href="https://dashboard.orchestrate.io/">Dashboard</a> (for help, see
       <a href="/#getting-started">here</a>).</p>
      <pre class="highlight java"><span class="c1">// An API key looks something like:</span>&#x000A;<span class="c1">//   3854bbd7-0a31-43b0-aa94-66236847a717</span>&#x000A;<span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrchestrateClient</span><span class="o">(</span><span class="s">&quot;your api key&quot;</span><span class="o">);</span></pre>
      <h4><a name="multi-data-center"></a> <a href="#multi-data-center">Choosing A Data Center</a></h4>
      
      <p>By default, the Orchestrate client uses &#39;AWS US East&rsquo; as its host data center. To use
       another data center, for example &#39;AWS EU West&rsquo;, you can switch the host when creating
       the client:</p>
      <pre class="highlight java"><span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">OrchestrateClient</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="s">&quot;your api key&quot;</span><span class="o">)</span>&#x000A;    <span class="o">.</span><span class="na">host</span><span class="o">(</span><span class="s">&quot;https://api.aws-eu-west-1.orchestrate.io&quot;</span><span class="o">)</span>&#x000A;    <span class="o">.</span><span class="na">build</span><span class="o">();</span></pre>
      <p>For more information on Orchestrate&rsquo;s Multi Data Center features check out
       <a href="http://orchestrate.io/docs/multi-data-center">the documentation</a>.</p>
      
      <p>A <code>Client</code> can be shared across threads and you only need to construct one per
       Java application. For more advanced configuration options, check out
       <a href="/advanced-options/#tuning">Tuning the Client</a>.</p>
      
      <h3><a name="stopping-client"></a> <a href="#stopping-client">Stopping a Client</a></h3>
      
      <p>Sometimes it&rsquo;s necessary to release the resources used by a <code>Client</code> and
       reconstruct it again at some later stage.</p>
      <pre class="highlight java"><span class="n">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// some method later, #get() a request will reallocate resources</span>&#x000A;<span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;someCollection&quot;</span><span class="o">,</span> <span class="s">&quot;someKey&quot;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">get</span><span class="o">();</span></pre>
      <h2><a name="key-value"></a> <a href="#key-value">Key-Value</a></h2>
      
      <p>Key-Value operations are the heart of the Orchestrate.io service. These are the
       most common operations you&rsquo;ll perform and is the primary way of storing data.</p>
      
      <p>All Key-Value operations happen in the context of a <code>Collection</code>. If the
       collection does not exist it will be <em>implicitly</em> created when data is first
       written. </p>
      
      <p>For the examples here, we will assume there is a collection called
       <code>users</code>. This collection will use emails as the users&rsquo; keys. We will 
       also map the response to a <code>User</code> class, which is a simple POJO class:</p>
      <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>&#x000A;    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>&#x000A;    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="n">User</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>&#x000A;        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>&#x000A;        <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="n">User</span><span class="o">()</span> <span class="o">{</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="n">String</span> <span class="n">getName</span><span class="o">()</span> <span class="o">{</span>&#x000A;        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>&#x000A;        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="n">String</span> <span class="n">getDescription</span><span class="o">()</span> <span class="o">{</span>&#x000A;        <span class="k">return</span> <span class="n">description</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>&#x000A;        <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="nd">@Override</span>&#x000A;    <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>&#x000A;        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>&#x000A;        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>&#x000A;&#x000A;        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>&#x000A;&#x000A;        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="nd">@Override</span>&#x000A;    <span class="kd">public</span> <span class="kt">int</span> <span class="n">hashCode</span><span class="o">()</span> <span class="o">{</span>&#x000A;        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>&#x000A;    <span class="o">}</span>&#x000A;<span class="o">}</span></pre>
      <h3><a name="fetch-data"></a> <a href="#fetch-data">Fetch Data</a></h3>
      
      <p>To fetch an object from our <code>users</code> <code>collection</code> with a given <code>key</code>.</p>
      <pre class="highlight java"><span class="n">KvObject</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userKv</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@email.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  <span class="c1">// send the HTTP GET request</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>           <span class="c1">// block and return the response</span>&#x000A;&#x000A;<span class="c1">// check the data exists</span>&#x000A;<span class="k">if</span> <span class="o">(</span><span class="n">userKv</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;User &#39;test@email.com&#39; does not exist.&quot;</span><span class="o">;</span>&#x000A;<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>&#x000A;    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userKv</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">userEmail</span> <span class="o">=</span> <span class="n">userKv</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">userKv</span><span class="o">.</span><span class="na">getRef</span><span class="o">();</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>&#x000A;      <span class="s">&quot;Read user key:%s, name:%s, ref:%s&quot;</span><span class="o">,</span>&#x000A;          <span class="n">userKey</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">ref</span>&#x000A;    <span class="o">));</span>&#x000A;<span class="o">}</span></pre>
      <p>This example shows how to retrieve the value for a key from a collection and
       deserialize the result JSON to a <a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object">POJO</a>.
       The User value is wrapped in a KvObject. This allows the client to provide the
       other metadata for the item. In the example, we show that the <code>key</code> and the <code>ref</code>
       are provided on the KvObject. The <code>ref</code> is a content-based hash that Orchestrate
       provides for the Item. This <code>ref</code> is used in Orchestrate&rsquo;s versioning history.</p>
      
      <h4><a name="fetch-data-by-ref"></a> <a href="#fetch-data-by-ref">Fetch Data by Ref</a></h4>
      
      <p>To fetch an object from a <code>collection</code> with a given <code>key</code> and specific <code>ref</code>. This
      is useful for fetching old versions of an Item.</p>
      <pre class="highlight java"><span class="c1">// this dummyRef would likely be provided from an earlier operation</span>&#x000A;<span class="n">String</span> <span class="n">dummyRef</span> <span class="o">=</span> <span class="s">&quot;a203b02a7d0b6de8&quot;</span><span class="o">;</span>&#x000A;<span class="n">KvObject</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userKv</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@email.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">dummyRef</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userKv</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>&#x000A;<span class="c1">// do something with the &#39;user&#39;</span></pre>
      <h3><a name="list-data"></a> <a href="#list-data">List Data</a></h3>
      
      <p>To list objects in a <code>collection</code>.</p>
      <pre class="highlight java"><span class="n">KvList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">listCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="k">for</span> <span class="o">(</span><span class="n">KvObject</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userKv</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="c1">// do something with the object</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userKv</span><span class="o">);</span>&#x000A;<span class="o">}</span></pre>
      <p>By default, only the first 10 objects are retrieved. This can be increased up to
       100 per request in <code>KvListResource#limit(int)</code> method.</p>
      
      <p>The <code>KvList</code> object returns a <code>next</code> field with a prepared request with the next
       group of objects (or <code>null</code> if there are no more objects), this can be used to
        paginate through the collection.</p>
      
      <p>It is also possible to retrieve a list of KV objects without their values by
       setting the <code>withValues(boolean)</code> method as the request is being built.</p>
      <pre class="highlight java"><span class="n">KvList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">listCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">withValues</span><span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  <span class="c1">// sends the HTTP GET request</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>           <span class="c1">// blocks and returns the response</span>&#x000A;&#x000A;<span class="k">for</span> <span class="o">(</span><span class="n">KvObject</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userKv</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="c1">// userKv.getValue() will be null here because we </span>&#x000A;    <span class="c1">// requested withValues(false)</span>&#x000A;    <span class="c1">// other metadata is available though:</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userKv</span><span class="o">.</span><span class="na">getKey</span><span class="o">()+</span><span class="s">&quot;,&quot;</span><span class="o">+</span><span class="n">userKv</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>&#x000A;&#x000A;<span class="o">}</span></pre>
      <p>In this case, all the metadata will be present on the KvObjects, but the <code>value</code>
      will be <code>null</code> on all of the results.</p>
      
      <h3><a name="store-data"></a> <a href="#store-data">Store Data</a></h3>
      
      <p>To store (add OR update) an object to a <code>collection</code> and a given <code>key</code>.</p>
      <pre class="highlight java"><span class="c1">// create some data to store</span>&#x000A;<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&quot;Chris&quot;</span><span class="o">,</span> <span class="s">&quot;Likes to code.&quot;</span><span class="o">);</span> <span class="c1">// a POJO</span>&#x000A;&#x000A;<span class="kd">final</span> <span class="n">KvMetadata</span> <span class="n">userMeta</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>   <span class="c1">// sends the HTTP PUT request</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>      <span class="c1">// blocks and returns the response</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the stored data</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userMeta</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <p>This example shows how to store a value for a key to a collection. <code>user</code> is
       serialized to JSON by the client before writing the data. If the key already
       existed in the collection, then this operation will replace the previous
       version of the item (the old version is still accessible via the 
       <a href="https://orchestrate.io/docs/apiref#refs">ref</a> of that version).</p>
      
      <p>The <code>KvMetadata</code> returned by the store operation contains information about
       where this new version of the item has been stored, including its version
       <code>ref</code>.</p>
      
      <h4><a name="conditional-store"></a> <a href="#conditional-store">Conditional Store</a></h4>
      
      <p>The <code>ref</code> metadata returned from a store operation is important, it allows
       you to perform a &ldquo;Conditional PUT&rdquo;.</p>
      <pre class="highlight java"><span class="c1">// update &#39;user&#39; if the latest version &#39;ref&#39; on the server matches </span>&#x000A;<span class="c1">// the provided &#39;lastRef&#39;</span>&#x000A;<span class="n">String</span> <span class="n">lastRef</span> <span class="o">=</span> <span class="s">&quot;a203b02a7d0b6de8&quot;</span><span class="o">;</span> <span class="c1">// likely kept from an earlier operation</span>&#x000A;<span class="k">try</span> <span class="o">{</span>&#x000A;    <span class="n">KvMetadata</span> <span class="n">updatedUserMeta</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">ifMatch</span><span class="o">(</span><span class="n">lastRef</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ItemVersionMismatchException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>&#x000A;   <span class="c1">// update failed because the refs do not match. This would usually</span>&#x000A;   <span class="c1">// mean the item was updated since we last read it.</span>&#x000A;<span class="o">}</span>&#x000A;</pre>
      <p>You may also want to be sure you are inserting a NEW Item, and not unintentionally
      updating an Item that was already written for the same key.</p>
      <pre class="highlight text">// store the new &#39;user&#39; data if the key &#39;test@test.com&#39; does not already exist&#x000A;try {&#x000A;    KvMetadata userMeta =&#x000A;        client.kv(&quot;users&quot;, &quot;test@test.com&quot;)&#x000A;              .ifAbsent()&#x000A;              .put(user)&#x000A;              .get();&#x000A;} catch (ItemAlreadyPresentException ex) {&#x000A;  // the key &#39;test@test.com&#39; already exists in the collection&#x000A;}</pre>
      <p>These &ldquo;conditional store&rdquo; operations are very useful in high write concurrency
       environments. They provide a pre-condition that must be <code>true</code> for the store
       operation to succeed.</p>
      
      <h4><a name="server-generated-keys"></a> <a href="#server-generated-keys">Store with Server-Generated Keys</a></h4>
      
      <p>With some types of data you&rsquo;ll store to Orchestrate you may want to have the
       service generate keys for the values for you. This is similar to using the
       <code>AUTO_INCREMENT</code> feature from other databases. Orchestrate&rsquo;s generated keys
       are NOT guaranteed to be monotonically increasing. They are roughly time 
       ordered though, and may be out of order by up to 1s.</p>
      
      <p>To store a value to a collection with a server-generated key:</p>
      <pre class="highlight java"><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&quot;Chris&quot;</span><span class="o">,</span> <span class="s">&quot;Likes to code.&quot;</span><span class="o">);</span> <span class="c1">// a POJO</span>&#x000A;<span class="n">KvMetadata</span> <span class="n">userMeta</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">postValue</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="c1">// print out the generated key</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userMeta</span><span class="o">.</span><span class="na">getKey</span><span class="o">);</span></pre>
      <h3><a name="partial-update-data"></a> <a href="#partial-update-data">Partial Update Data</a></h3>
      
      <p>To update only a portion of an item (eg to update a few fields).</p>
      <pre class="highlight java"><span class="kd">final</span> <span class="n">KvMetadata</span> <span class="n">updatedMeta</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">patch</span><span class="o">(</span><span class="n">JsonPatch</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;            <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;description&quot;</span><span class="o">,</span> <span class="s">&quot;Likes all code.&quot;</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="s">&quot;views&quot;</span><span class="o">)</span>          <span class="c1">// increment a &#39;views&#39; counter</span>&#x000A;            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;tags/-&quot;</span><span class="o">,</span><span class="s">&quot;coder&quot;</span><span class="o">)</span> <span class="c1">// append to a &#39;tags&#39; array</span>&#x000A;            <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;        <span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the stored data</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updatedMeta</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <p>This operation allows for updating a portion of a document by applying a
       list of operations. Each of the operations will be applied to the specified
       document in order. If any of the operations fails for any reason, then the
       patch is aborted, and none of the changes are applied.
       The response metadata will contain the new &#39;ref&rsquo; for the updated item. For
       a full list of supported Ops, see the JsonPatch <a href="/javadoc/latest/io/orchestrate/client/jsonpatch/JsonPatch.html">Javadocs</a>.
      .</p>
      
      <h4><a name="conditional-partial-update-data"></a> <a href="#conditional-partial-update-data">Conditional Partial Update Data</a></h4>
      
      <p>This patch operation also supports the ifMatch conditional. When updating
       individual fields, it is recommended that you keep the &#39;ref&rsquo; of the item
       you are modifying. Then, when sending the update, provide the original &#39;ref&rsquo;
       to insure the updates are being applied to the expected version.</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">lastRef</span> <span class="o">=</span> <span class="s">&quot;a203b02a7d0b6de8&quot;</span><span class="o">;</span> <span class="c1">// likely kept from an earlier operation</span>&#x000A;<span class="kd">final</span> <span class="n">KvMetadata</span> <span class="n">updatedMeta</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ifMatch</span><span class="o">(</span><span class="n">lastRef</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">patch</span><span class="o">(</span><span class="n">JsonPatch</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;            <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;description&quot;</span><span class="o">,</span> <span class="s">&quot;Likes all code.&quot;</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;        <span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the stored data</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">kvMetadata</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <h4><a name="test-operation"></a> <a href="#test-operation">Test Operation</a></h4>
      
      <p>One of the JsonPatch ops available is the &#39;test&rsquo; op. This op deserves special
       mention. The &#39;test&rsquo; op provides a way to indicate a field value based precondition
       for the patch operation. The operations will be applied to the document in
       the order specified. If any &#39;test&rsquo; op fails, the entire patch is aborted, and
       NONE of the ops will be &#39;committed&rsquo; to the store.</p>
      <pre class="highlight java"><span class="k">try</span> <span class="o">{</span>&#x000A;    <span class="kd">final</span> <span class="n">KvMetadata</span> <span class="n">updatedMeta</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;             <span class="o">.</span><span class="na">patch</span><span class="o">(</span><span class="n">JsonPatch</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;                 <span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="s">&quot;description&quot;</span><span class="o">,</span> <span class="s">&quot;Likes to code.&quot;</span><span class="o">)</span>&#x000A;                 <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;description&quot;</span><span class="o">,</span> <span class="s">&quot;Likes ALL code.&quot;</span><span class="o">)</span>&#x000A;                 <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;             <span class="o">)</span>&#x000A;             <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;    <span class="c1">// print the &#39;ref&#39; for the stored data</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updatedMeta</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>&#x000A;<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TestOpApplyException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>&#x000A;   <span class="c1">// the patch failed to apply due to a &#39;test&#39; op failure.</span>&#x000A;   <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Test op at index &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getOpIndex</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; failed. Data: &quot;</span><span class="o">+</span><span class="n">ex</span><span class="o">.</span><span class="na">getDetails</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>&#x000A;<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PatchConflictException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>&#x000A;   <span class="c1">// the patch failed to apply due to one of the &#39;path&#39;s</span>&#x000A;   <span class="c1">// specified in one of the ops does not exist (ie it may have</span>&#x000A;   <span class="c1">// been removed by another update of the item).</span>&#x000A;   <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Patch Op at index &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getOpIndex</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; failed. Data: &quot;</span><span class="o">+</span><span class="n">ex</span><span class="o">.</span><span class="na">getDetails</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>&#x000A;<span class="o">}</span></pre>
      <h4><a name="merge-update-data"></a> <a href="#merge-update-data">Merge Update Data</a></h4>
      
      <p>To update an Item by merging it with another (via a JsonMergePatch
       https://tools.ietf.org/html/rfc7386). </p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">changesJson</span> <span class="o">=</span> <span class="s">&quot;{\&quot;description\&quot;:\&quot;Looking at Rust.\&quot;}&quot;</span>&#x000A;<span class="kd">final</span> <span class="n">KvMetadata</span> <span class="n">updatedMeta</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">changesJson</span><span class="o">)</span>   <span class="c1">// send the HTTP PATCH Request</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>               <span class="c1">// block and return the meta  </span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the stored data</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updatedMeta</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <p>This operation allows for updating a JSON document by merging it with
      another JSON document that contains new values to apply to the original.</p>
      
      <p>The usefulness of this method in the Java client is likely limited to only
      command line type utilities that are processing sets of changes
      from other sources (otherwise, it is unlikely a normal Java domain object
      will be only partially populated). Due to this limited utility, this
      method only takes a JSON string. Please provide feedback if your use case
      does not fit this assumption.</p>
      
      <h4><a name="conditional-merge-update-data"></a> <a href="#conditional-merge-update-data">Conditional Merge Update Data</a></h4>
      
      <p>This merge operation also supports the ifMatch conditional. When merging
      json documents, it is recommended that you keep the &#39;ref&rsquo; of the item
      you are modifying. Then, when sending the update, provide the original &#39;ref&rsquo;
      to insure the updates are being applied to the expected version.</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">lastRef</span> <span class="o">=</span> <span class="s">&quot;a203b02a7d0b6de8&quot;</span><span class="o">;</span> <span class="c1">// likely kept from an earlier operation</span>&#x000A;<span class="n">String</span> <span class="n">changesJson</span> <span class="o">=</span> <span class="s">&quot;{\&quot;description\&quot;:\&quot;Looking at Elixir.\&quot;}&quot;</span>&#x000A;<span class="kd">final</span> <span class="n">KvMetadata</span> <span class="n">updatedMeta</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ifMatch</span><span class="o">(</span><span class="n">lastRef</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">changesJson</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the stored data</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updatedMeta</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <h4><a name="conditional-update-failures"></a> <a href="#conditional-update-failures">Conditional Partial Update Failures</a></h4>
      
      <p>When a conditional partial update (either patch or merge) fails, NONE of the operations
      are applied. The failure indicates that the precondition failed (ie the item has been
      modified since the provided ref). This failure is reflected in the client by an exception
      being thrown.</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">lastRef</span> <span class="o">=</span> <span class="s">&quot;a203b02a7d0b6de8&quot;</span><span class="o">;</span> <span class="c1">// likely kept from an earlier operation</span>&#x000A;<span class="k">try</span> <span class="o">{</span>&#x000A;    <span class="kd">final</span> <span class="n">KvMetadata</span> <span class="n">kvMetadata</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">ifMatch</span><span class="o">(</span><span class="n">lastRef</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">patch</span><span class="o">(</span><span class="n">JsonPatch</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;                <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;description&quot;</span><span class="o">,</span> <span class="s">&quot;Looking at Heartforth.&quot;</span><span class="o">)</span>&#x000A;                <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;            <span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PatchConflictException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>&#x000A;   <span class="c1">// the patch failed to apply due to either a &#39;test&#39; failure or</span>&#x000A;   <span class="c1">// one of the &#39;path&#39;s specified in one of the ops does not exist</span>&#x000A;   <span class="c1">// (ie it may have been removed by another update of the item).</span>&#x000A;   <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Patch Op at index &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getOpIndex</span><span class="o">()</span> <span class="o">+</span>&#x000A;        <span class="s">&quot; failed. Data: &quot;</span><span class="o">+</span><span class="n">ex</span><span class="o">.</span><span class="na">getDetails</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>&#x000A;<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ItemVersionMismatchException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>&#x000A;   <span class="c1">// patch failed to apply because the &#39;lastRef&#39; does not match</span>&#x000A;   <span class="c1">// the latest version for the key in the collection</span>&#x000A;<span class="o">}</span>&#x000A;</pre>
      <p>If an item key is updated VERY frequently, then there is a chance that a patch request for
      that key could result in a ItemVersionMismatchException, even if it was not sent
      with an ifMatch header.</p>
      <pre class="highlight java"><span class="k">try</span> <span class="o">{</span>&#x000A;    <span class="kd">final</span> <span class="n">KvMetadata</span> <span class="n">kvMetadata</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;someCollection&quot;</span><span class="o">,</span> <span class="s">&quot;someKey&quot;</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">patch</span><span class="o">(</span><span class="n">JsonPatch</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;                <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;description&quot;</span><span class="o">,</span> <span class="s">&quot;Looking at Purescript.&quot;</span><span class="o">)</span>&#x000A;                <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;            <span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PatchConflictException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>&#x000A;   <span class="c1">// the patch failed to apply due to either a &#39;test&#39; failure or</span>&#x000A;   <span class="c1">// one of the &#39;path&#39;s specified in one of the ops does not exist</span>&#x000A;   <span class="c1">// (ie it may have been removed by another update of the item).</span>&#x000A;<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ItemVersionMismatchException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>&#x000A;   <span class="c1">// since there was NO ifMatch value sent, this means the</span>&#x000A;   <span class="c1">// patch failed to apply due to too many other requests to</span>&#x000A;   <span class="c1">// update the same item key</span>&#x000A;<span class="o">}</span>&#x000A;</pre>
      <h3><a name="delete-data"></a> <a href="#delete-data">Delete Data</a></h3>
      
      <p>To delete an object by <code>key</code> in a <code>collection</code>.</p>
      <pre class="highlight java"><span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;someCollection&quot;</span><span class="o">,</span> <span class="s">&quot;someKey&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">delete</span><span class="o">()</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Successfully deleted the collection.&quot;</span><span class="o">);</span>&#x000A;<span class="o">}</span></pre>
      <p>You can also delete an entire <code>collection</code>. This is a very rare operation, since it will
      remove all the data in the collection. Deleting a collection is analgous to doing
      a <code>drop table</code> in a relational database.</p>
      <pre class="highlight java"><span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">deleteCollection</span><span class="o">(</span><span class="n">collection</span><span class="o">)</span> <span class="c1">// send DELETE</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>                       <span class="c1">// block for response</span>&#x000A;&#x000A;<span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Successfully deleted the collection.&quot;</span><span class="o">);</span>&#x000A;<span class="o">}</span></pre>
      <h4><a name="conditional-delete"></a> <a href="#conditional-delete">Conditional Delete</a></h4>
      
      <p>Similar to a <a href="#conditional-store">conditional store</a> operation, a conditional
       delete provides a pre-condition that must be <code>true</code> for the operation to
       succeed.</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">lastRef</span> <span class="o">=</span> <span class="s">&quot;a203b02a7d0b6de8&quot;</span><span class="o">;</span> <span class="c1">// likely kept from an earlier operation</span>&#x000A;<span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">ifMatch</span><span class="o">(</span><span class="n">lastRef</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">delete</span><span class="o">()</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Successfully deleted the item.&quot;</span><span class="o">);</span>&#x000A;<span class="o">}</span></pre>
      <p>The object with the key <code>test@test.com</code> will be deleted if and only if the
       <code>lastRef</code> matches the current ref for the object on the server.</p>
      
      <h4><a name="purge-kv-data"></a> <a href="#purge-kv-data">Purge Data</a></h4>
      
      <p>The Orchestrate service is built on the principle that all data is immutable,
       every change made to an object is stored as a new object with a different <code>ref</code>.
       This <a href="https://orchestrate.io/docs/apiref#refs-list"><code>ref history</code></a>
       is maintained even after an object has been deleted, it makes
       it possible to recover deleted objects easily and rollback to an earlier version
       of the object.</p>
      
      <p>Nevertheless there will be times when you may need to delete an object and purge
       all <code>ref history</code> for the object.</p>
      <pre class="highlight java"><span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Successfully purged the key.&quot;</span><span class="o">);</span>&#x000A;<span class="o">}</span></pre>
      <h2><a name="search"></a> <a href="#search">Search</a></h2>
      
      <p>A powerful feature of the Orchestrate.io service is the search functionality;
       when an object is written to the platform the data will be semantically indexed
       in the background.</p>
      
      <p>This allows you to perform search queries on the data without any extra
       configuration hassle and no need to run a separate search cluster of some kind
       to ask questions about the data stored.</p>
      
      <p>The query language used to perform searches is the familiar
       <a href="http://lucene.apache.org/core/4_3_0/queryparser/org/apache/lucene/queryparser/classic/package-summary.html#Overview">Lucene Syntax</a>,
       any Lucene query is a valid Orchestrate.io search query.</p>
      
      <p>The simplest search query is a <code>*</code> query. This is what a query against 
      the <code>users</code> collection would look like:</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="k">for</span> <span class="o">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="c1">// do something with the search results</span>&#x000A;    <span class="n">KvObject</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userKv</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getKvObject</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">userKv</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">userKev</span><span class="o">.</span><span class="na">getRef</span><span class="o">();</span>&#x000A;    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userKv</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>&#x000A;&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>&#x000A;      <span class="s">&quot;Found user email:%s, name:%s, ref:%s&quot;</span><span class="o">,</span>&#x000A;          <span class="n">key</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">ref</span>&#x000A;    <span class="o">));</span>&#x000A;<span class="o">}</span></pre>
      <p>A more complex search query could look like this:</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;description:java&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">50</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">offset</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// same as above</span></pre>
      <p>The collection called <code>users</code> will be searched with the query <code>description:java</code>
       (which finds users whose description contains &#39;java&rsquo;) and return
       up to <code>50</code> results, starting at offset <code>10</code> (limit and offset are a
       common pagination mechanism). The result values will be deserialized 
       to <code>User</code> instances.</p>
      
      <p>In some cases, it may be helpful to only retrieve the matching keys (and refs).
      In this case, use &#39;withValues(Boolean.FALSE)&rsquo; to indicate that the item values
      should not be included in the response.</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">50</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">offset</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">withValues</span><span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="k">for</span> <span class="o">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="c1">// do something with the search results</span>&#x000A;    <span class="n">KvObject</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">userKv</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getKvObject</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">email</span> <span class="o">=</span> <span class="n">userKv</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>&#x000A;    <span class="c1">// userKv.getValue() will be null because the search request</span>&#x000A;    <span class="c1">// has &quot;withValues(false)&quot;. </span>&#x000A;&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">email</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span><span class="o">+</span><span class="n">result</span><span class="o">.</span><span class="na">getScore</span><span class="o">());</span>&#x000A;<span class="o">}</span></pre>
      <h4><a name="query-note"></a> <a href="#query-note">Note</a></h4>
      
      <p>By default, the search functionality will only search Kv Items. To search events, you must
      specify a <code>path metadata</code> predicate: <code>@path.kind:event</code>. See <a href="#search-events">Search Events</a>
      for more on searching for events.</p>
      
      <h4><a name="query-note"></a> <a href="#query-note">Note</a></h4>
      
      <p>Search results are currently limited to no more than <strong>100</strong> results for each
       query, if this limit is not suitable for you please let us know.</p>
      
      <p>By default, a search operation will only return up to <strong>10</strong> results, use the
       <code>CollectionSearchResource</code> as shown above to retrieve more results for a query.</p>
      
      <h4><a name="query-examples"></a> <a href="#query-examples">Some Example Queries</a></h4>
      
      <p>Here are some query examples demonstrating the Lucene query syntax.</p>
      
      <p>In these examples, <code>DomainObject</code> is just a normal java POJO like the <code>User</code>
      class in other examples.</p>
      <pre class="highlight java"><span class="c1">// keyword matching</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;title:\&quot;foo bar\&quot;&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">DomainObject</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;someCollection&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// proximity matching</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;\&quot;foo bar\&quot;~4&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">DomainObject</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;someCollection&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// range searches</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;year_of_birth:[20020101 TO 20030101]&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">DomainObject</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;someCollection&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span></pre>
      <p>The backslashes in the first two examples are necessary to escape
       the quotes in the Java string literal, so that the query is sent 
       as a <code>phrase query</code>. If the query didn&rsquo;t have the inner quotes
       (for example: &ldquo;title: foo bar&rdquo;, would be a logical OR, where
       title could have <code>foo</code> OR <code>bar</code>).  </p>
      
      <h2><a name="aggregates"></a> <a href="#aggregates">Aggregate Functions</a></h2>
      
      <p>In the Orchestrate.io search API, any query can be optionally accompanied by a
      collection of aggregate functions, each providing a summary of the data items
      matched by the query. There are four different kinds of aggregate functions:
      Statistical, Range, Distance, and TimeSeries.</p>
      
      <p>Here are a few examples to show how to use aggregate functions in common
      scenarios. Again, <code>DomainObject</code> is just a POJO, just like our previous <code>User</code> 
      examples.</p>
      <pre class="highlight java"><span class="c1">// Stats Aggregate: Generate a statistical summary of the prices of items in your users&#39; shopping carts</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">DomainObject</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;shopping_cart&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">Aggregate</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;                  <span class="o">.</span><span class="na">stats</span><span class="o">(</span><span class="s">&quot;value.items.price&quot;</span><span class="o">)</span>&#x000A;                  <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;              <span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;*&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// Range Aggregate: Create a range histogram of user ratings for a particular product</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;value.product_id:`ABC123`&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">DomainObject</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;user_ratings&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">Aggregate</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;                  <span class="o">.</span><span class="na">range</span><span class="o">(</span>&#x000A;                      <span class="s">&quot;value.number_of_stars&quot;</span><span class="o">,</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">0.0</span><span class="o">,</span> <span class="mf">1.0</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">1.0</span><span class="o">,</span> <span class="mf">2.0</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">2.0</span><span class="o">,</span> <span class="mf">3.0</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">3.0</span><span class="o">,</span> <span class="mf">4.0</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">4.0</span><span class="o">,</span> <span class="mf">5.0</span><span class="o">)</span>&#x000A;                  <span class="o">)</span>&#x000A;                  <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;              <span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// Distance Aggregate: Count the number of Chinese restaurants within various distance ranges (0 - 1 km, 1 - 2 km, etc)</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;value.cuisine:chinese AND value.location:NEAR:{ lat:12.34 lon:56.78 dist:5km }&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">DomainObject</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;restaurants&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">Aggregate</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;                  <span class="o">.</span><span class="na">distance</span><span class="o">(</span>&#x000A;                      <span class="s">&quot;value.location&quot;</span><span class="o">,</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">0.0</span><span class="o">,</span> <span class="mf">1.0</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">1.0</span><span class="o">,</span> <span class="mf">2.0</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">2.0</span><span class="o">,</span> <span class="mf">3.0</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">3.0</span><span class="o">,</span> <span class="mf">4.0</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mf">4.0</span><span class="o">,</span> <span class="mf">5.0</span><span class="o">)</span>&#x000A;                  <span class="o">)</span>&#x000A;                  <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;              <span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// TimeSeries Aggregate: Count the number new users per day, over the past 30 days,</span>&#x000A;<span class="c1">// in my local time zone, &quot;-0800&quot; (Pacific Standard Time is eight hours behind UTC).</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;value.signup_date:[2014-11-01 TO 2014-12-01]&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">DomainObject</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">Aggregate</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;                  <span class="o">.</span><span class="na">timeSeries</span><span class="o">(</span><span class="s">&quot;value.signup_date&quot;</span><span class="o">,</span> <span class="n">TimeInterval</span><span class="o">.</span><span class="na">DAY</span><span class="o">,</span> <span class="s">&quot;-0800&quot;</span><span class="o">)</span>&#x000A;                  <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;              <span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span></pre>
      <p>You can include multiple different aggregate functions in a single query by chaining calls to
      the AggregateBuilder. For example, this query includes both a Statistical and Range aggregate
      on the same field, as well as two different TimeSeries aggregates, with different intervals and
      different fields:</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;value.performer:radiohead&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">DomainObject</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;concert_tickets&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">Aggregate</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;                  <span class="o">.</span><span class="na">stats</span><span class="o">(</span><span class="s">&quot;value.sale_price&quot;</span><span class="o">)</span>&#x000A;                  <span class="o">.</span><span class="na">range</span><span class="o">(</span>&#x000A;                      <span class="s">&quot;value.sale_price&quot;</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">below</span><span class="o">(</span><span class="mi">25</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mi">25</span><span class="o">,</span> <span class="mi">50</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mi">50</span><span class="o">,</span> <span class="mi">75</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="mi">75</span><span class="o">,</span> <span class="mi">100</span><span class="o">),</span>&#x000A;                      <span class="n">Range</span><span class="o">.</span><span class="na">above</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>&#x000A;                  <span class="o">)</span>&#x000A;                  <span class="o">.</span><span class="na">timeSeries</span><span class="o">(</span><span class="s">&quot;value.performance_date&quot;</span><span class="o">,</span> <span class="n">TimeInterval</span><span class="o">.</span><span class="na">MONTH</span><span class="o">)</span>&#x000A;                  <span class="o">.</span><span class="na">timeSeries</span><span class="o">(</span><span class="s">&quot;value.transaction_date&quot;</span><span class="o">,</span> <span class="n">TimeInterval</span><span class="o">.</span><span class="na">DAY</span><span class="o">)</span>&#x000A;                  <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;              <span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span></pre>
      <h2><a name="events"></a> <a href="#events">Events</a></h2>
      
      <p>In the Orchestrate.io service, an event is a time ordered piece of data you want
       to store in the context of a key. This specialist storage type exists because
       we believe it&rsquo;s pretty common in the design of most applications.</p>
      
      <p>Some examples of types of objects you&rsquo;d want to store as events are; comments
       that belong to a blog article, items in a user&rsquo;s news feed from a social
       network, or billing history from a customer.</p>
      
      <p>For the Event examples, we will assume we have a &ldquo;users&rdquo; <code>collection</code> and that 
      each user <code>key</code> has an event called <code>logs</code>. We will show the results being mapped to a
      <code>LogItem</code> class. You would replace that class with one of your own, and it 
      just needs to be a normal POJO class (java bean conventions). For
      our examples, we&rsquo;ll assume that <code>LogItem</code> looks like this:</p>
      <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogItem</span> <span class="o">{</span>&#x000A;    <span class="kd">private</span> <span class="n">String</span> <span class="n">source</span><span class="o">;</span>&#x000A;    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="n">LogItem</span><span class="o">()</span> <span class="o">{</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="n">LogItem</span><span class="o">(</span><span class="n">String</span> <span class="n">source</span><span class="o">,</span> <span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>&#x000A;        <span class="k">this</span><span class="o">.</span><span class="na">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">;</span>&#x000A;        <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="n">String</span> <span class="n">getSource</span><span class="o">()</span> <span class="o">{</span>&#x000A;        <span class="k">return</span> <span class="n">source</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setSource</span><span class="o">(</span><span class="n">String</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>&#x000A;        <span class="k">this</span><span class="o">.</span><span class="na">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="n">String</span> <span class="n">getDescription</span><span class="o">()</span> <span class="o">{</span>&#x000A;        <span class="k">return</span> <span class="n">description</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;&#x000A;    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>&#x000A;        <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>&#x000A;    <span class="o">}</span>&#x000A;<span class="o">}</span></pre>
      <h3><a name="fetch-events"></a> <a href="#fetch-events">Fetch Events</a></h3>
      
      <p>To fetch events belonging to a <code>key</code> in a specific <code>collection</code> of a specific
       <code>type</code>, where type could be a name like &ldquo;activities&rdquo;, &ldquo;comments&rdquo; or &ldquo;feed&rdquo;.</p>
      <pre class="highlight java"><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;&gt;</span> <span class="n">events</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span> <span class="c1">// the event type name to fetch from</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LogItem</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// send the GET request, map responses to LogItem instances</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// iterate on the events, they will be ordered by the most recent value</span>&#x000A;<span class="k">for</span> <span class="o">(</span><span class="n">Event</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="n">event</span> <span class="o">:</span> <span class="n">events</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="kt">long</span> <span class="n">eventTimestamp</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">();</span>&#x000A;    <span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">eventTimestamp</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">logItem</span><span class="o">.</span><span class="na">getDescription</span><span class="o">());</span>&#x000A;<span class="o">}</span></pre>
      <p>You can also supply an optional <code>start</code> and <code>end</code> timestamp to retrieve a subset
       of the events.</p>
      <pre class="highlight java"><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="mi">0L</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">end</span><span class="o">(</span><span class="mi">1369832019085L</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LogItem</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// same as above</span></pre>
      <h4><a name="fetch-single-event"></a> <a href="#fetch-single-event">Fetch Single Event</a></h4>
      
      <p>To fetch an individual event instance.</p>
      <pre class="highlight java"><span class="c1">// here, the timestamp and ordinal are likely from an earlier</span>&#x000A;<span class="c1">// operation response.</span>&#x000A;<span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">Long</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">612808568709574700L</span>&#x000A;<span class="n">Event</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="n">event</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">ordinal</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LogItem</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">logItem</span><span class="o">.</span><span class="na">getDescription</span><span class="o">());</span></pre>
      <h4><a name="search-events"></a> <a href="#search-events">Search Events</a></h4>
      
      <p>Events can be searched using the same Search api. To find events, the query must 
      include the predicate for finding events: <code>@path.kind:event</code>. This <code>path metadata</code> predicate
      indicates we are only searching for <code>event</code> objects. This meta defaults to <code>item</code> so that 
      ONLY items are returned unless <code>@path.kind</code> is specified explicitly. </p>
      
      <p>By specifying the <code>@path.kind:event</code> you are able to search for events across keys 
      in a collection.</p>
      <pre class="highlight java"><span class="c1">// @path.kind:event will search only events, and</span>&#x000A;<span class="c1">// @path.type:activities will search only the &#39;activities&#39; event type</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;@path.kind:event AND @path.type:activities AND description:website&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LogItem</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="k">for</span><span class="o">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="nl">result:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">Event</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="n">logEvent</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getEventObject</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">logEvent</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>&#x000A;    <span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">logEvent</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">();</span>&#x000A;    <span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="n">logEvent</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>&#x000A;&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>&#x000A;      <span class="s">&quot;Found event key:%s, timestamp:%s, description:%s&quot;</span><span class="o">,</span>&#x000A;          <span class="n">key</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">logItem</span><span class="o">.</span><span class="na">getDescription</span><span class="o">()</span>&#x000A;    <span class="o">));</span>&#x000A;<span class="o">}</span></pre>
      <p>There is a convenience method to set the &#39;kind&rsquo; metadata predicate for you:</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;@path.type:activities AND description:website&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">kinds</span><span class="o">(</span><span class="s">&quot;event&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LogItem</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="c1">// same as above</span></pre>
      <p>You can also Sort by the event <code>timestamp</code> metadata, so the results are ordered most
      recent first.</p>
      <pre class="highlight java"><span class="c1">// @path.type:activities will search only the &#39;activities&#39; event type</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;@path.type:activities AND description:website&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">kinds</span><span class="o">(</span><span class="s">&quot;event&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="s">&quot;@path.timestamp:desc&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LogItem</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="k">for</span><span class="o">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="nl">result:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">Event</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="n">logEvent</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getEventObject</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">logEvent</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>&#x000A;    <span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">logEvent</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">();</span>&#x000A;    <span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="n">logEvent</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>&#x000A;&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>&#x000A;      <span class="s">&quot;Found event key:%s, timestamp:%s, description:%s&quot;</span><span class="o">,</span>&#x000A;          <span class="n">key</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">logItem</span><span class="o">.</span><span class="na">getDescription</span><span class="o">()</span>&#x000A;    <span class="o">));</span>&#x000A;<span class="o">}</span></pre>
      <p>Searching across event types works too, but will require a bit more handling since 
      the different event types will likely map to different Java Objects.</p>
      <pre class="highlight java"><span class="c1">// find ANY events with description containing &quot;website&quot;</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;description:website&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">kinds</span><span class="o">(</span><span class="s">&quot;event&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="k">for</span><span class="o">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nl">result:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">Event</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">eventResult</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getEventObject</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">eventResult</span><span class="o">.</span><span class="na">getType</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">eventResult</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>&#x000A;    <span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">eventResult</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">();</span>&#x000A;&#x000A;    <span class="k">if</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">eventType</span><span class="o">))</span> <span class="o">{</span>&#x000A;      <span class="c1">// assuming our app maps &#39;activity&#39; events to a POJO class called LogItem</span>&#x000A;      <span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="n">eventResult</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">LogItem</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>&#x000A;&#x000A;      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>&#x000A;        <span class="s">&quot;Found ACTIVITY: key:%s, timestamp:%s, description:%s&quot;</span><span class="o">,</span>&#x000A;            <span class="n">key</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">logItem</span><span class="o">.</span><span class="na">getDescription</span><span class="o">()</span>&#x000A;      <span class="o">));</span>&#x000A;    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="s">&quot;payments&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">eventType</span><span class="o">))</span> <span class="o">{</span>&#x000A;      <span class="c1">// assuming our app maps &#39;payment&#39; events to a POJO class called UserPayment</span>&#x000A;      <span class="n">UserPayment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">eventResult</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">UserPayment</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>&#x000A;&#x000A;      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>&#x000A;        <span class="s">&quot;Found PAYMENT: key:%s, timestamp:%s, description:%s&quot;</span><span class="o">,</span>&#x000A;            <span class="n">key</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">payment</span><span class="o">.</span><span class="na">getDescription</span><span class="o">()</span>&#x000A;      <span class="o">));</span>&#x000A;    <span class="o">}</span>&#x000A;<span class="o">}</span>&#x000A;</pre>
      <p>You can also perform a search for KV Items AND Events.</p>
      <pre class="highlight java"><span class="c1">// find ANY KV Items or Events with description containing &quot;website&quot;</span>&#x000A;<span class="n">String</span> <span class="n">luceneQuery</span> <span class="o">=</span> <span class="s">&quot;description:website&quot;</span><span class="o">;</span>&#x000A;<span class="n">SearchResults</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">searchCollection</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">kinds</span><span class="o">(</span><span class="s">&quot;item&quot;</span><span class="o">,</span> <span class="s">&quot;event&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">luceneQuery</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="k">for</span><span class="o">(</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nl">result:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">KvObject</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">kvResult</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getKvObject</span><span class="o">();</span>&#x000A;    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">kvResult</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>&#x000A;    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isEvent</span><span class="o">())</span> <span class="o">{</span>&#x000A;       <span class="n">Event</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">eventResult</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getEventObject</span><span class="o">();</span>&#x000A;       <span class="n">String</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">eventResult</span><span class="o">.</span><span class="na">getType</span><span class="o">();</span>&#x000A;        <span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">eventResult</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">();</span>&#x000A;&#x000A;       <span class="k">if</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">eventType</span><span class="o">))</span> <span class="o">{</span>&#x000A;         <span class="c1">// assuming our app maps &#39;activity&#39; events to a POJO class called LogItem</span>&#x000A;         <span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="n">eventResult</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">LogItem</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>&#x000A;&#x000A;         <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>&#x000A;           <span class="s">&quot;Found ACTIVITY: key:%s, timestamp:%s, description:%s&quot;</span><span class="o">,</span>&#x000A;               <span class="n">key</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">logItem</span><span class="o">.</span><span class="na">getDescription</span><span class="o">()</span>&#x000A;         <span class="o">));</span>&#x000A;       <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="s">&quot;payments&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">eventType</span><span class="o">))</span> <span class="o">{</span>&#x000A;         <span class="c1">// assuming our app maps &#39;payment&#39; events to a POJO class called UserPayment</span>&#x000A;         <span class="n">UserPayment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">eventResult</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">UserPayment</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>&#x000A;&#x000A;         <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>&#x000A;           <span class="s">&quot;Found PAYMENT: key:%s, timestamp:%s, description:%s&quot;</span><span class="o">,</span>&#x000A;               <span class="n">key</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">payment</span><span class="o">.</span><span class="na">getDescription</span><span class="o">()</span>&#x000A;         <span class="o">));</span>&#x000A;       <span class="o">}</span>&#x000A;    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>&#x000A;        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">kvResult</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>&#x000A;        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>&#x000A;           <span class="s">&quot;Found USER: key:%s, description:%s&quot;</span><span class="o">,</span>&#x000A;               <span class="n">key</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getDescription</span><span class="o">()</span>&#x000A;         <span class="o">));</span>&#x000A;    <span class="o">}</span>&#x000A;<span class="o">}</span>&#x000A;</pre>
      <h3><a name="store-event"></a> <a href="#store-event">Store Event</a></h3>
      
      <p>You can think of storing an event like adding to the front of a time-ordered
       immutable list of objects.</p>
      
      <p>To store an event to a <code>key</code> in a <code>collection</code> with a specific <code>type</code>.</p>
      <pre class="highlight java"><span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogItem</span><span class="o">(</span><span class="s">&quot;website&quot;</span><span class="o">,</span> <span class="s">&quot;viewed homepage&quot;</span><span class="o">);</span>&#x000A;<span class="n">EventMetadata</span> <span class="n">result</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">logItem</span><span class="o">)</span>  <span class="c1">// send the HTTP POST requst</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>           <span class="c1">// block waiting for the response</span>&#x000A;&#x000A;<span class="c1">// Print the timestamp and ordinal of the newly created event</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">+</span><span class="n">result</span><span class="o">.</span><span class="na">getOrdinal</span><span class="o">());</span></pre>
      <p>You can also supply an optional <code>timestamp</code> for the event, this will be used
       instead of the timestamp of the write operation. This may be useful if your
       Events already have a timestamp (ie from a log file).</p>
      <pre class="highlight java"><span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogItem</span><span class="o">(</span><span class="s">&quot;website&quot;</span><span class="o">,</span> <span class="s">&quot;viewed homepage&quot;</span><span class="o">);</span>&#x000A;<span class="n">EventMetadata</span> <span class="n">result</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">logItem</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// Print the timestamp and ordinal of the newly created event</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">+</span><span class="n">result</span><span class="o">.</span><span class="na">getOrdinal</span><span class="o">());</span></pre>
      <h3><a name="update-event"></a> <a href="#update-event">Update Event</a></h3>
      
      <p>To update an Event to a new version.</p>
      <pre class="highlight java"><span class="c1">// here, the timestamp and ordinal are likely from an earlier</span>&#x000A;<span class="c1">// operation response.</span>&#x000A;<span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">Long</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">612808568709574700L</span>&#x000A;<span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogItem</span><span class="o">(</span><span class="s">&quot;website&quot;</span><span class="o">,</span> <span class="s">&quot;viewed homepage *corrected to remove sensitive data*&quot;</span><span class="o">);</span>&#x000A;<span class="kd">final</span> <span class="n">EventMetadata</span> <span class="n">updatedMeta</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;eventType&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">ordinal</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">logItem</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the updated event</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updatedMeta</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <p>This operation allows for updating an Event by sending in an updated value
       for the Event.</p>
      
      <h4><a name="conditional-update-event"></a> <a href="#conditional-update-event">Conditional Update Event</a></h4>
      
      <p>To update an Event to a new version but only if the ref of the Event being updated matches
      the provided value. This insures that the update is being applied to the expected version.</p>
      <pre class="highlight java"><span class="c1">// here, the timestamp and ordinal are likely from an earlier</span>&#x000A;<span class="c1">// operation response.</span>&#x000A;<span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">Long</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">612808568709574700L</span>&#x000A;<span class="kd">final</span> <span class="n">Event</span><span class="o">&lt;</span><span class="n">LogItem</span><span class="o">&gt;</span> <span class="n">currentEvent</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">ordinal</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LogItem</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="n">LogItem</span> <span class="n">logItem</span> <span class="o">=</span> <span class="n">currentEvent</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>&#x000A;<span class="n">logItem</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">&quot;Updated!&quot;</span><span class="o">);</span>&#x000A;&#x000A;<span class="kd">final</span> <span class="n">EventMetadata</span> <span class="n">updatedMeta</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">currentEvent</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">())</span>&#x000A;        <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">currentEvent</span><span class="o">.</span><span class="na">getOrdinal</span><span class="o">())</span>&#x000A;        <span class="o">.</span><span class="na">ifMatch</span><span class="o">(</span><span class="n">currentEvent</span><span class="o">.</span><span class="na">getRef</span><span class="o">())</span>&#x000A;        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">logItem</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the updated event</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updatedMeta</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <p>This operation allows for updating an Event by sending in an updated value
       for the Event.</p>
      
      <h3><a name="partial-update-event"></a> <a href="#partial-update-event">Partial Update Event</a></h3>
      
      <p>To update only a portion of an Event (eg to update a few fields).</p>
      <pre class="highlight java"><span class="c1">// here, the timestamp and ordinal are likely from an earlier</span>&#x000A;<span class="c1">// operation response.</span>&#x000A;<span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">Long</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">612808568709574700L</span>&#x000A;<span class="kd">final</span> <span class="n">EventMetadata</span> <span class="n">eventMetadata</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">ordinal</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">patch</span><span class="o">(</span><span class="n">JsonPatch</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;            <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;description&quot;</span><span class="o">,</span> <span class="s">&quot;Updated!&quot;</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;        <span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the updated event</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">eventMetadata</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <p>This operation allows for updating a portion of an Event by applying a
       list of operations. Each of the operations will be applied to the specified
       event in order. If any of the operations fails for any reason, then the
       patch is aborted, and none of the changes are applied.
       The response metadata will contain the new &#39;ref&rsquo; for the updated event. For
       a full list of supported Ops, see the JsonPatch <a href="/javadoc/latest/io/orchestrate/client/jsonpatch/JsonPatch.html">Javadocs</a>.</p>
      
      <h4><a name="conditional-partial-update-event"></a> <a href="#conditional-partial-update-event">Conditional Partial Update Event</a></h4>
      
      <p>This patch operation also supports the ifMatch conditional. When updating
       individual fields, it is recommended that you keep the &#39;ref&rsquo; of the event
       you are modifying. Then, when sending the update, provide the original &#39;ref&rsquo;
       to insure the updates are being applied to the expected version.</p>
      <pre class="highlight java"><span class="c1">// here, the timestamp, ordinal, and ref are likely from an earlier</span>&#x000A;<span class="c1">// operation response.</span>&#x000A;<span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">Long</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">612808568709574700L</span>&#x000A;<span class="n">String</span> <span class="n">ref</span> <span class="o">=</span> <span class="s">&quot;82eafab14dc84ed3&quot;</span><span class="o">;</span>&#x000A;<span class="kd">final</span> <span class="n">EventMetadata</span> <span class="n">eventMetadata</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">ordinal</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ifMatch</span><span class="o">(</span><span class="n">ref</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">patch</span><span class="o">(</span><span class="n">JsonPatch</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>&#x000A;            <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;description&quot;</span><span class="o">,</span> <span class="s">&quot;Updated!&quot;</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">build</span><span class="o">()</span>&#x000A;        <span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the updated event</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">eventMetadata</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <h4><a name="merge-update-event"></a> <a href="#merge-update-event">Merge Update Event</a></h4>
      
      <p>To update an Event by merging it with another (via a JsonMergePatch
       https://tools.ietf.org/html/rfc7386).</p>
      <pre class="highlight java"><span class="c1">// here, the timestamp and ordinal are likely from an earlier</span>&#x000A;<span class="c1">// operation response.</span>&#x000A;<span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">Long</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">612808568709574700L</span>&#x000A;&#x000A;<span class="n">String</span> <span class="n">changesJson</span> <span class="o">=</span> <span class="s">&quot;{\&quot;description\&quot;:\&quot;Updated!!\&quot;}&quot;</span>&#x000A;<span class="kd">final</span> <span class="n">EventMetadata</span> <span class="n">eventMetadata</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">ordinal</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">changesJson</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the updated event</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">eventMetadata</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <p>This operation allows for updating an event&rsquo;s JSON document by merging it with
      another JSON document that contains new values to apply to the original.</p>
      
      <p>The usefulness of this method in the Java client is likely limited to only
      command line type utilities that are processing sets of changes
      from other sources (otherwise, it is unlikely a normal Java domain object
      will be only partially populated). Due to this limited utility, this
      method only takes a JSON string. Please provide feedback if your use case
      does not fit this assumption.</p>
      
      <h4><a name="conditional-merge-update-event"></a> <a href="#conditional-merge-update-event">Conditional Merge Update Event</a></h4>
      
      <p>This merge operation also supports the ifMatch conditional. When merging
      json documents, it is recommended that you keep the &#39;ref&rsquo; of the event
      you are modifying. Then, when sending the update, provide the original &#39;ref&rsquo;
      to insure the updates are being applied to the expected version.</p>
      <pre class="highlight java"><span class="c1">// here, the timestamp, ordinal, and ref are likely from an earlier</span>&#x000A;<span class="c1">// operation response.</span>&#x000A;<span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">Long</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">612808568709574700L</span>&#x000A;<span class="n">String</span> <span class="n">ref</span> <span class="o">=</span> <span class="s">&quot;82eafab14dc84ed3&quot;</span><span class="o">;</span>&#x000A;&#x000A;<span class="n">String</span> <span class="n">changesJson</span> <span class="o">=</span> <span class="s">&quot;{\&quot;description\&quot;:\&quot;Updated!!\&quot;}&quot;</span>&#x000A;<span class="kd">final</span> <span class="n">EventMetadata</span> <span class="n">eventMetadata</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">ordinal</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ifMatch</span><span class="o">(</span><span class="n">ref</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">changesJson</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// print the &#39;ref&#39; for the updated event</span>&#x000A;<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">eventMetadata</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span></pre>
      <h3><a name="delete-event"></a> <a href="#delete-event">Delete Event</a></h3>
      
      <p>To delete an individual Event instance</p>
      <pre class="highlight java"><span class="c1">// here, the timestamp and ordinal are likely from an earlier</span>&#x000A;<span class="c1">// operation response.</span>&#x000A;<span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">Long</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">612808568709574700L</span>&#x000A;&#x000A;<span class="kd">final</span> <span class="n">Boolean</span> <span class="n">purged</span> <span class="o">=</span>&#x000A;    <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">ordinal</span><span class="o">)</span>&#x000A;        <span class="o">.</span><span class="na">purge</span><span class="o">()</span>&#x000A;        <span class="o">.</span><span class="na">get</span><span class="o">();</span></pre>
      <h4><a name="conditional-delete-event"></a> <a href="#conditional-delete-event">Conditional Delete Event</a></h4>
      
      <p>To delete an individual Event instance, but only if the current version is the expected ref.</p>
      <pre class="highlight java"><span class="c1">// here, the timestamp, ordinal, and ref are likely from an earlier</span>&#x000A;<span class="c1">// operation response.</span>&#x000A;<span class="n">Long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1369832019085L</span><span class="o">;</span>&#x000A;<span class="n">Long</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">612808568709574700L</span>&#x000A;<span class="n">String</span> <span class="n">ref</span> <span class="o">=</span> <span class="s">&quot;82eafab14dc84ed3&quot;</span><span class="o">;</span>&#x000A;&#x000A;<span class="k">try</span> <span class="o">{</span>&#x000A;    <span class="kd">final</span> <span class="n">Boolean</span> <span class="n">purged</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="s">&quot;activities&quot;</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">timestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="n">ordinal</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">ifMatch</span><span class="o">(</span><span class="n">ref</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">purge</span><span class="o">()</span>&#x000A;            <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ItemVersionMismatchException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>&#x000A;   <span class="c1">// the ref did not match.</span>&#x000A;<span class="o">}</span></pre>
      <h2><a name="graph"></a> <a href="#graph">Graph</a></h2>
      
      <p>While building an application it&rsquo;s possible that you&rsquo;ll want to make associations
       between particular objects of the same type or even objects of completely
       different types that share a property of some kind.</p>
      
      <p>It&rsquo;s this sort of data problem that makes the graph features in Orchestrate
       shine, if you&rsquo;re building a socially-aware application you might want to
       add relations between data like &ldquo;friend&rdquo; or &ldquo;follows&rdquo;.</p>
      
      <p>A graph query is the right choice when you have a starting object that you want
       search from to follow relevant relationships and accumulate interesting
       information.</p>
      
      <h3><a name="fetch-relations"></a> <a href="#fetch-relations">Fetch Relations</a></h3>
      
      <p>To fetch objects related to the <code>key</code> in the <code>collection</code> based on a
       relationship or number of <code>relation</code>s.</p>
      <pre class="highlight java"><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">KvObject</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">relation</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="c1">// here we say the related object result should be mapped as a User</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;friend&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="k">for</span> <span class="o">(</span><span class="n">KvObject</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">String</span> <span class="n">friendEmail</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>&#x000A;    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>&#x000A;    <span class="c1">// the raw JSON string</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">friendEmail</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>&#x000A;<span class="o">}</span></pre>
      <p>Imagine that we&rsquo;d like to know the <code>follow</code>ers of <code>users</code> that are <code>friend</code>s of
       the user with key <code>test@test.com</code>. This kind of query could look like this.</p>
      <pre class="highlight java"><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">KvObject</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="n">results</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">relation</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;friend&quot;</span><span class="o">,</span> <span class="s">&quot;follow&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="c1">// same as above</span></pre>
      <h3><a name="store-relation"></a> <a href="#store-relation">Store Relation</a></h3>
      
      <p>To store a <code>relation</code> between one <code>key</code> to another <code>key</code> within the same
       <code>collection</code> or across different <code>collection</code>s.</p>
      <pre class="highlight java"><span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">relation</span><span class="o">(</span><span class="s">&quot;sourceCollection&quot;</span><span class="o">,</span> <span class="s">&quot;sourceKey&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;destCollection&quot;</span><span class="o">,</span> <span class="s">&quot;destKey&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;someKind&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Successfully stored the relation.&quot;</span><span class="o">);</span>&#x000A;<span class="o">}</span></pre>
      <h4><a name="graph-note"></a> <a href="#graph-note">Note</a></h4>
      
      <p>Relationships in Orchestrate are uni-directional, to define a bi-directional
       relation you must swap the <code>collection</code> &lt;-&gt; <code>toCollection</code> and <code>key</code> &lt;-&gt; <code>toKey</code>
       parameters.</p>
      
      <p>We may lift this restriction in a future release of the client.</p>
      
      <h3><a name="purge-relation"></a> <a href="#purge-relation">Purge Relation</a></h3>
      
      <p>To purge a <code>relation</code> between one <code>key</code> to another <code>key</code> within the same
       <code>collection</code> or across different <code>collection</code>s.</p>
      <pre class="highlight java"><span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">relation</span><span class="o">(</span><span class="s">&quot;sourceCollection&quot;</span><span class="o">,</span> <span class="s">&quot;sourceKey&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;destCollection&quot;</span><span class="o">,</span> <span class="s">&quot;destKey&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">purge</span><span class="o">(</span><span class="s">&quot;someKind&quot;</span><span class="o">)</span>&#x000A;              <span class="o">.</span><span class="na">get</span><span class="o">();</span>&#x000A;&#x000A;<span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">{</span>&#x000A;    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Successfully purged the relation.&quot;</span><span class="o">);</span>&#x000A;<span class="o">}</span></pre>
      <h2><a name="async-api"></a> <a href="#async-api">Asynchronous API</a></h2>
      
      <p>Any Resource method that returns an OrchestrateRequest will initiate an asynchronous
       http request to the Orchestrate service. For example:</p>
      <pre class="highlight java"><span class="n">OrchestrateRequest</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> &#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;someCollection&quot;</span><span class="o">,</span> <span class="s">&quot;someKey&quot;</span><span class="o">)</span>&#x000A;            <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span></pre>
      <p>The get(Class) method will return an OrchestrateRequest that has been initiated
       asynchronously to the Orchestrate service. To handle the result, you will need to either
       register a listener on that request, or block waiting for the response by calling the
       <code>get</code> method on the request.</p>
      
      <p>This is what a typical non-blocking call might look like:</p>
      <pre class="highlight java"><span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">;</span>&#x000A;<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&quot;test1&quot;</span><span class="o">,</span> <span class="s">&quot;Some description&quot;</span><span class="o">);</span>&#x000A;<span class="kd">final</span> <span class="n">OrchestrateRequest</span><span class="o">&lt;</span><span class="n">KvMetadata</span><span class="o">&gt;</span> <span class="n">addUserRequest</span> <span class="o">=</span>&#x000A;        <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="n">collection</span><span class="o">(),</span> <span class="n">key</span><span class="o">)</span>&#x000A;                <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>&#x000A;                <span class="o">.</span><span class="na">on</span><span class="o">(</span><span class="k">new</span> <span class="n">ResponseAdapter</span><span class="o">&lt;</span><span class="n">KvMetadata</span><span class="o">&gt;()</span> <span class="o">{</span>&#x000A;                      <span class="nd">@Override</span>&#x000A;                      <span class="kd">public</span> <span class="kt">void</span> <span class="n">onFailure</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>&#x000A;                          <span class="c1">// handle error condition</span>&#x000A;                      <span class="o">}</span>&#x000A;&#x000A;                      <span class="nd">@Override</span>&#x000A;                      <span class="kd">public</span> <span class="kt">void</span> <span class="n">onSuccess</span><span class="o">(</span><span class="kd">final</span> <span class="n">KvMetadata</span> <span class="n">userKvMeta</span><span class="o">)</span> <span class="o">{</span>&#x000A;                          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;User Added. Ref=&quot;</span><span class="o">+</span><span class="n">userKvMeta</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>&#x000A;                      <span class="o">}</span>&#x000A;                <span class="o">});</span></pre>
      <p>A blocking call:</p>
      <pre class="highlight java"><span class="n">DomainObject</span> <span class="n">object</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;someCollection&quot;</span><span class="o">,</span> <span class="s">&quot;someKey&quot;</span><span class="o">)</span>&#x000A;      <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>&#x000A;      <span class="o">.</span><span class="na">get</span><span class="o">();</span></pre>
      <p>The final <code>get()</code> call will block until the result is returned. It takes an optional timeout
       and defaults to 2.5 seconds.</p>
      
      <p>You can also add listeners, even if you ultimately call <code>get()</code> to block waiting for the
      result:</p>
      <pre class="highlight java"><span class="n">DomainObject</span> <span class="n">object</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">kv</span><span class="o">(</span><span class="s">&quot;someCollection&quot;</span><span class="o">,</span> <span class="s">&quot;someKey&quot;</span><span class="o">)</span>&#x000A;      <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DomainObject</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>&#x000A;      <span class="o">.</span><span class="na">on</span><span class="o">(</span><span class="k">new</span> <span class="n">ResponseAdapter</span><span class="o">&lt;</span><span class="n">KvObject</span><span class="o">&lt;</span><span class="n">DomainObject</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>&#x000A;          <span class="nd">@Override</span>&#x000A;          <span class="kd">public</span> <span class="kt">void</span> <span class="n">onFailure</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>&#x000A;              <span class="c1">// handle error condition</span>&#x000A;          <span class="o">}</span>&#x000A;&#x000A;          <span class="nd">@Override</span>&#x000A;          <span class="kd">public</span> <span class="kt">void</span> <span class="n">onSuccess</span><span class="o">(</span><span class="kd">final</span> <span class="n">DomainObject</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>&#x000A;              <span class="c1">// do something with the result</span>&#x000A;          <span class="o">}</span>&#x000A;      <span class="o">})</span>&#x000A;      <span class="o">.</span><span class="na">get</span><span class="o">();</span></pre>
      <footer>Orchestrate.io &copy; 2014</footer>
    </div>
  </body>
</html>
